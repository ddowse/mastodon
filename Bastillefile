
ARG EMAIL
ARG DOMAIN
ARG WITH_REDIS

PKG libxslt libxml2 postgresql-libpqxx yarn-node16 autoconf nginx git-lite readline libyaml lzlib ruby rubygem-bundler libidn gmake acme.sh bash ImageMagick7-nox11

# Get Certificate from Let's Encrypt  
CMD acme.sh --home /var/db/acme.sh --register-account -m ${EMAIL} --server letsencrypt
CMD acme.sh --home /var/db/acme.sh --issue --standalone -d ${DOMAIN} --listen-v6 --server letsencrypt

# IPv4
#CMD acme.sh --home /var/db/acme.sh --issue --standalone -d ${DOMAIN} --listen-v4

CMD mkdir -p /usr/local/etc/ssl/letsencrypt/${DOMAIN}
CMD acme.sh --home /var/db/acme.sh --install-cert -d ${DOMAIN} --fullchain-file /usr/local/etc/ssl/letsencrypt/${DOMAIN}/fullchain.pem --key-file /usr/local/etc/ssl/letsencrypt/${DOMAIN}/privkey.pem
CMD echo '0       0       *       *       *       root    acme.sh --cron --home "/var/db/acme.sh" --reloadcmd "service nginx restart" > /dev/null' >> /etc/crontab

# Copy and Render configurations 
CP usr /
RENDER /usr/local/etc/nginx/mastodon.conf

# Redis disable protected-mode 
CMD if [ -n "${WITH_REDIS}" ]; then pkg install redis; sed -i '' -e 's/protected-mode yes/protected-mode no/' /usr/local/etc/redis.conf; service redis enable; service redis start; fi

# Bootstrap Application
CMD pw useradd -n mastodon -m -G redis -s /usr/local/bin/bash
CMD su mastodon -c "git clone https://github.com/mastodon/mastodon.git /home/mastodon/live" 
CMD su mastodon -c "cd /home/mastodon/live && git checkout $(git tag -l | grep -v 'rc[0-9]*$' | sort -V | tail -n 1)"
CMD su mastodon -c "cd /home/mastodon/live && bundle config deployment 'true'"
CMD su mastodon -c "cd /home/mastodon/live && bundle config without 'development test'"
CMD su mastodon -c "cd /home/mastodon/live && bundle install -j$(getconf _NPROCESSORS_ONLN)"
CMD su mastodon -c "cd /home/mastodon/live && yarn install --pure-lockfile --ignore-platform"

# Enable all services
SYSRC nginx_enable="YES"
SYSRC mastodon_web="YES"
SYSRC masodon_sidekiq="YES"
SYSRC mastodon_streaming="YES"

# Run the interactive setup wizard 
# CMD su mastodon -c "cd /home/mastodon/live && RAILS_ENV=production bundle exec rake mastodon:setup"

SERVICE nginx start
SERVICE mastodon_web start
SERVICE masodon_sidekiq start
SERVICE mastodon_streaming start
